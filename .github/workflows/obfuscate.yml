# .github/workflows/obfuscate.yml
name: obfuscate-on-dispatch
on:
  repository_dispatch:
    types: [prometheus-obfuscate]

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: install dependencies
        run: |
          sudo apt-get update
          
          # Install LuaJIT, LuaRocks, C build essentials, and MongoDB C dependencies
          sudo apt-get install -y luajit luarocks build-essential libbson-dev libmongoc-dev
          
          # Install the Lua MongoDB driver rock
          sudo luarocks install lua-mongo
          
      - name: run obfuscator and write to DB (with Lua path setup)
        env:
          USER_CODE: ${{ github.event.client_payload.code || '' }}
          PROM_PRESET: ${{ github.event.client_payload.preset || 'Strong' }}
          JOB_ID: ${{ github.event.client_payload.job_id || '' }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          # CRITICAL PATH FIX:
          # This command evaluates the output of `luarocks path` to set LUA_PATH 
          # and LUA_CPATH environment variables in the current shell session.
          # This ensures luajit can find the lua-mongo module.
          eval $(luarocks path)
          
          chmod +x ./runner.lua || true
          luajit ./runner.lua

